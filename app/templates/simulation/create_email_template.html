{% extends "layouts/app.html" %}

{% block title %}Create Email Template - PhishGuard{% endblock %}

{% block page_content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Create Email Template</h1>
        <a href="{{ url_for('simulation.email_templates') }}"
            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Templates
        </a>
    </div>

    <form method="POST" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {{ form.hidden_tag() }}

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Template Details</h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-2">
                            {{ form.name.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                            {{ form.name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                            form.name.errors else "")) }}
                            {% if form.name.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.name.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            {{ form.category.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                            {{ form.category(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                            form.category.errors else "")) }}
                            {% if form.category.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.category.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            {{ form.description.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                            {{ form.description(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                            form.description.errors else ""), rows="3") }}
                            {% if form.description.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.description.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            {{ form.difficulty_level.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                            {{ form.difficulty_level(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                            form.difficulty_level.errors else "")) }}
                            {% if form.difficulty_level.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.difficulty_level.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="mt-1 text-xs text-gray-500">
                                <div><strong>Low:</strong> Easy to identify as phishing</div>
                                <div><strong>Medium:</strong> Moderately convincing</div>
                                <div><strong>High:</strong> Very convincing and sophisticated</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Email Content</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            {{ form.sender_name.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                            {{ form.sender_name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-primary-500 focus:ring-primary-500 sm:text-sm" + (" border-red-300" if
                            form.sender_name.errors else "")) }}
                            {% if form.sender_name.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.sender_name.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            {{ form.sender_email.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                            {{ form.sender_email(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                            form.sender_email.errors else "")) }}
                            {% if form.sender_email.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.sender_email.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div>
                        {{ form.subject.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.subject(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                        focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                        form.subject.errors else "")) }}
                        {% if form.subject.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.subject.errors %}
                            <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.html_content.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.html_content(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                        focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                        form.html_content.errors else ""), rows="15", id="htmlEditor") }}
                        {% if form.html_content.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.html_content.errors %}
                            <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="mt-1 text-sm text-gray-500">
                            Use HTML to format your email content. The tracking link will be automatically inserted.
                        </div>
                    </div>

                    <div>
                        {{ form.landing_page_url.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.landing_page_url(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                        focus:border-blue-500 focus:ring-blue-500 sm:text-sm" + (" border-red-300" if
                        form.landing_page_url.errors else "")) }}
                        {% if form.landing_page_url.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.landing_page_url.errors %}
                            <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="mt-1 text-sm text-gray-500">
                            The URL that users will be redirected to when they click the phishing link. Leave blank to
                            use the default awareness page.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Actions</h3>
                </div>
                <div class="p-6 space-y-3">
                    <button type="submit"
                        class="w-full flex justify-center items-center px-4 py-2 bg-primary-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-save mr-2"></i> Save Template
                    </button>
                    <button type="button" onclick="previewTemplate()"
                        class="w-full flex justify-center items-center px-4 py-2 bg-white border border-blue-300 rounded-md shadow-sm text-sm font-medium text-blue-700 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-eye mr-2"></i> Preview
                    </button>
                    <a href="{{ url_for('simulation.email_templates') }}"
                        class="w-full flex justify-center items-center px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-times mr-2"></i> Cancel
                    </a>
                </div>
            </div>

            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-base font-medium text-gray-900">Template Variables</h3>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-4">You can use these variables in your email content:</p>
                    <div class="space-y-3 text-sm">
                        <div>
                            <code
                                class="px-2 py-1 bg-gray-100 rounded text-xs">{{ '{{' }}employee.first_name{{ '}}' }}</code>
                            <div class="text-gray-500 text-xs mt-1">Employee's first name</div>
                        </div>
                        <div>
                            <code
                                class="px-2 py-1 bg-gray-100 rounded text-xs">{{ '{{' }}employee.last_name{{ '}}' }}</code>
                            <div class="text-gray-500 text-xs mt-1">Employee's last name</div>
                        </div>
                        <div>
                            <code
                                class="px-2 py-1 bg-gray-100 rounded text-xs">{{ '{{' }}employee.email{{ '}}' }}</code>
                            <div class="text-gray-500 text-xs mt-1">Employee's email address</div>
                        </div>
                        <div>
                            <code
                                class="px-2 py-1 bg-gray-100 rounded text-xs">{{ '{{' }}employee.department{{ '}}' }}</code>
                            <div class="text-gray-500 text-xs mt-1">Employee's department</div>
                        </div>
                        <div>
                            <code
                                class="px-2 py-1 bg-gray-100 rounded text-xs">{{ '{{' }}employee.position{{ '}}' }}</code>
                            <div class="text-gray-500 text-xs mt-1">Employee's position</div>
                        </div>
                        <div>
                            <code class="px-2 py-1 bg-gray-100 rounded text-xs">{{ '{{' }}tracking_url{{ '}}' }}</code>
                            <div class="text-gray-500 text-xs mt-1">Phishing link (auto-generated)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-base font-medium text-gray-900">Template Library</h3>
                </div>
                <div class="p-6 space-y-2">
                    <button type="button" onclick="loadTemplate('urgent_security')"
                        class="w-full text-left px-3 py-2 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Urgent Security Alert
                    </button>
                    <button type="button" onclick="loadTemplate('account_suspension')"
                        class="w-full text-left px-3 py-2 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Account Suspension
                    </button>
                    <button type="button" onclick="loadTemplate('password_expiry')"
                        class="w-full text-left px-3 py-2 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Password Expiry
                    </button>
                    <button type="button" onclick="loadTemplate('invoice_payment')"
                        class="w-full text-left px-3 py-2 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Invoice Payment
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3">
            <h3 class="text-lg font-bold text-gray-900">Email Preview</h3>
            <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
        <div class="py-4">
            <div id="previewContent">
                <!-- Preview content will be loaded here -->
            </div>
        </div>
        <div class="flex justify-end pt-2">
            <button type="button" onclick="closePreviewModal()"
                class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    function previewTemplate() {
        const subject = document.getElementById('subject').value;
        const senderName = document.getElementById('sender_name').value;
        const senderEmail = document.getElementById('sender_email').value;
        const htmlContent = document.getElementById('htmlEditor').value;

        document.getElementById('previewContent').innerHTML =
            '<div class="mb-3"><strong>Subject:</strong> ' + subject + '</div>' +
            '<div class="mb-3"><strong>From:</strong> ' + senderName + ' &lt;' + senderEmail + '&gt;</div>' +
            '<div class="border rounded p-3">' + htmlContent + '</div>';

        document.getElementById('previewModal').classList.remove('hidden');
    }

    function closePreviewModal() {
        document.getElementById('previewModal').classList.add('hidden');
    }

    function loadTemplate(templateType) {
        const templates = {
            'urgent_security': {
                subject: 'URGENT: Security Breach - Immediate Action Required',
                content: '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;"><div style="background-color: #dc3545; color: white; padding: 15px; text-align: center;"><h2>SECURITY ALERT</h2></div><div style="padding: 20px; background-color: #f8f9fa;"><p>Dear {{ "{{" }}employee.first_name{{ "}}" }},</p><p>We have detected suspicious activity on your account.</p><p>Please click the link below to verify your account:</p><div style="text-align: center; margin: 30px 0;"><a href="{{ "{{" }}tracking_url{{ "}}" }}" style="background-color: #dc3545; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">SECURE MY ACCOUNT NOW</a></div><p>Best regards,<br>IT Security Team</p></div></div>'
            },
            'password_expiry': {
                subject: 'Password Expiry Notification - Update Required',
                content: '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;"><div style="background-color: #17a2b8; color: white; padding: 15px; text-align: center;"><h2>PASSWORD EXPIRY NOTICE</h2></div><div style="padding: 20px;"><p>Hello {{ "{{" }}employee.first_name{{ "}}" }},</p><p>Your password for {{ "{{" }}employee.email{{ "}}" }} will expire in 3 days.</p><p>Click the button below to update your password now:</p><div style="text-align: center; margin: 30px 0;"><a href="{{ "{{" }}tracking_url{{ "}}" }}" style="background-color: #28a745; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">UPDATE PASSWORD</a></div><p>Best regards,<br>IT Department</p></div></div>'
            }
        };

        if (templates[templateType]) {
            document.getElementById('subject').value = templates[templateType].subject;
            document.getElementById('htmlEditor').value = templates[templateType].content;
        }
    }
</script>
{% endblock %}
